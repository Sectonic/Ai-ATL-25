# Database configuration - dynamically use current system user
USER := env_var_or_default("USER", "postgres")
DATABASE_URL := "postgresql://" + USER + "@localhost/atl_parcels"

# Build the backend in release mode
build:
  cargo build --release
  mv target/release/backend bin/backend

# Run the backend in production mode
run:
  #!/usr/bin/env bash
  export DATABASE_URL={{DATABASE_URL}}
  bin/backend

# Run the backend in development mode
dev:
  cargo run

# Test the backend endpoints
test:
  #!/usr/bin/env bash
  BASE_URL="http://localhost:8080"
  echo "Testing backend endpoints..."
  echo ""
  
  echo "Testing POST /api/simulate (streaming)"
  echo "-----------------------------------"
  echo "Note: Chunks should appear one at a time as they're generated"
  echo ""
  curl -X POST "${BASE_URL}/api/simulate" \
    -H "Content-Type: application/json" \
    -d '{
      "prompt": "Build a new light rail line connecting Midtown to the airport",
      "cityMetrics": {
        "population": 498715,
        "averageIncome": 68500,
        "unemploymentRate": 3.8,
        "housingAffordabilityIndex": 72,
        "trafficCongestionIndex": 68,
        "airQualityIndex": 85,
        "crimeRate": 4.2
      },
      "selectedZones": ["midtown", "downtown"],
      "neighborhoodProperties": []
    }' \
    -N \
    --no-buffer \
    -w "\n\nHTTP Status: %{http_code}\n" \
    -s
  echo ""
  echo ""
  
  echo "All endpoint tests completed!"

clean:
  cargo clean && rm -rf bin/backend